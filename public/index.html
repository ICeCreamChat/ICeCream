<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#020617">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <title>ICeCream - ç»Ÿä¸€æ™ºèƒ½å¹³å°</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <meta name="description" content="ICeCream ç»Ÿä¸€æ™ºèƒ½å¹³å° - AI èŠå¤©ã€æ•°å­¦åŠ¨ç”»å¯è§†åŒ–ã€æ™ºèƒ½è§£é¢˜">

    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/smart-board.css">
    <link rel="stylesheet" href="css/mobile.css">
    <link rel="stylesheet" href="css/tools.css">
    <link rel="stylesheet" href="css/seating-planner.css">

    <!-- Google Fonts -->
    <!-- Google Fonts (Pro Max Design System) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- KaTeX -->
    <!-- KaTeX CSS handled by dynamic loader below -->

    <script src="js/libs/lucide.min.js"></script>
    <script>if (window.lucide) { window.lucide.createIcons(); }</script>

    <!-- Libraries -->
    <!-- Libraries with Fallback -->
    <script defer src="js/libs/marked.min.js"></script>

    <!-- KaTeX with multiple CDNs for stability -->
    <script>
        // [Fix] Define monacoReady ONCE in global scope BEFORE any module loads
        let _resolveMonacoReady;
        window.monacoReady = new Promise(resolve => { _resolveMonacoReady = resolve; });

        function loadScript(src, fallbackSrcs) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.crossOrigin = "anonymous";
                script.onload = resolve;
                script.onerror = () => {
                    if (fallbackSrcs.length > 0) {
                        console.warn(`Failed to load ${src}, trying fallback...`);
                        loadScript(fallbackSrcs.shift(), fallbackSrcs).then(resolve).catch(reject);
                    } else {
                        reject(new Error(`All sources failed for ${src}`));
                    }
                };
                document.head.appendChild(script);
            });
        }

        // Load KaTeX CSS
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://unpkg.com/katex@0.16.9/dist/katex.min.css';
        link.onerror = () => {
            link.href = 'https://cdn.bootcdn.net/ajax/libs/KaTeX/0.16.9/katex.min.css';
        };
        document.head.appendChild(link);

        // Load KaTeX JS sequentially
        (function () {
            const katexSrcs = [
                'https://unpkg.com/katex@0.16.9/dist/katex.min.js',
                'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js',
                'https://cdn.bootcdn.net/ajax/libs/KaTeX/0.16.9/katex.min.js'
            ];
            const autoRenderSrcs = [
                'https://unpkg.com/katex@0.16.9/dist/contrib/auto-render.min.js',
                'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js',
                'https://cdn.bootcdn.net/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js'
            ];

            loadScript(katexSrcs.shift(), katexSrcs)
                .then(() => loadScript(autoRenderSrcs.shift(), autoRenderSrcs))
                .then(() => {
                    console.log('KaTeX Loaded Successfully');
                    // [Fix] Load Monaco ONLY after KaTeX to avoid AMD conflict
                    return loadScript('js/libs/monaco/vs/loader.js', []);
                })
                .then(() => {
                    console.log('Monaco Loader Initialized');
                    // Configure Monaco
                    require.config({ paths: { 'vs': 'js/libs/monaco/vs' } });
                    require(['vs/editor/editor.main'], function () {
                        console.log('Monaco initialized via deferred promise');
                        if (_resolveMonacoReady) _resolveMonacoReady(window.monaco);
                    });
                })
                .catch(err => console.error('Resource Load Failed:', err));
            // Remove DOMContentLoaded wrapper to start asap
            // window.addEventListener('DOMContentLoaded', ...) replaced by immediate execution
        })(); // Execute immediately
    </script>

    <!-- Three.js for particle effects (local) -->
    <script type="importmap">
        {
            "imports": {
                "three": "./js/libs/three.module.js"
            }
        }
    </script>
</head>

<body>
    <!-- èƒŒæ™¯åŠ¨ç”»å®¹å™¨ -->
    <div id="math-canvas-container"></div>

    <div class="glass-wrapper">
        <!-- ç§»åŠ¨ç«¯èœå•æŒ‰é’® -->
        <button id="mobile-menu-btn" class="icon-btn" aria-label="æ‰“å¼€èœå•">
            <i data-lucide="menu"></i>
        </button>

        <div class="app-layout">
            <!-- ä¾§è¾¹æ é®ç½© (Moved to top for Z-Index Stacking) -->
            <div id="sidebar-overlay" class="overlay"></div>

            <!-- ä¾§è¾¹æ  -->
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div class="brand">
                        <i data-lucide="snowflake" class="brand-icon"></i>
                        <span class="brand-text">ICeCream</span>
                    </div>
                    <button id="new-chat-btn" class="new-chat-btn">
                        <i data-lucide="plus"></i> æ–°å»ºå¯¹è¯
                    </button>
                </div>

                <div class="history-list" id="history-list">
                    <!-- å†å²è®°å½•å°†åŠ¨æ€ç”Ÿæˆ -->
                </div>

                <div class="sidebar-footer">
                    <div class="model-badge">ICeCream v1.0</div>
                </div>
            </aside>

            <!-- ä¸»åŒºåŸŸ -->
            <main class="main-content">
                <!-- é¡¶éƒ¨æ  -->
                <header class="header-bar">
                    <div class="header-left">
                        <span class="status-dot"></span>
                        <span class="header-title">ICeCream</span>
                    </div>

                    <!-- Mode Switcher -->
                    <div class="mode-switcher" id="mode-switcher">
                        <button class="mode-tab active" data-mode="auto" title="è‡ªåŠ¨è¯†åˆ«æ„å›¾">
                            <i data-lucide="sparkles"></i>
                            <span>è‡ªåŠ¨</span>
                        </button>
                        <button class="mode-tab" data-mode="chat" title="æ™®é€šå¯¹è¯">
                            <i data-lucide="message-circle"></i>
                            <span>èŠå¤©</span>
                        </button>
                        <button class="mode-tab" data-mode="manim" title="ç”ŸæˆåŠ¨ç”»">
                            <i data-lucide="clapperboard"></i>
                            <span>åŠ¨ç”»</span>
                        </button>
                        <button class="mode-tab" data-mode="solver" title="æ™ºèƒ½è§£é¢˜">
                            <i data-lucide="calculator"></i>
                            <span>è§£é¢˜</span>
                        </button>
                    </div>

                    <div class="header-right">
                        <button class="icon-btn apps-btn" id="apps-btn" title="è¯¾å ‚å·¥å…·ç®±">
                            <i data-lucide="layout-grid"></i>
                        </button>
                        <button class="icon-btn" id="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜">
                            <i data-lucide="sun" class="icon-light"></i>
                            <i data-lucide="moon" class="icon-dark"></i>
                        </button>
                    </div>
                </header>

                <!-- æ¶ˆæ¯åˆ—è¡¨ -->
                <div class="messages" id="messages">
                    <!-- æ¬¢è¿æ¶ˆæ¯ -->
                    <div class="welcome-screen" id="welcome-screen">
                        <div class="welcome-icon">
                            <i data-lucide="snowflake"></i>
                        </div>
                        <h1 class="welcome-title">æ¬¢è¿ä½¿ç”¨ ICeCream</h1>
                        <p class="welcome-subtitle">ç»Ÿä¸€æ™ºèƒ½å¹³å° - èŠå¤© Â· åŠ¨ç”» Â· è§£é¢˜</p>

                        <div class="welcome-features">
                            <div class="feature-card" data-mode="chat">
                                <i data-lucide="message-circle"></i>
                                <h3>æ™ºèƒ½å¯¹è¯</h3>
                                <p>åŸºäº DeepSeek çš„ AI èŠå¤©åŠ©æ‰‹</p>
                            </div>
                            <div class="feature-card" data-mode="manim">
                                <i data-lucide="clapperboard"></i>
                                <h3>æ•°å­¦åŠ¨ç”»</h3>
                                <p>è‡ªç„¶è¯­è¨€æè¿°ï¼Œç”Ÿæˆ Manim åŠ¨ç”»</p>
                            </div>
                            <div class="feature-card" data-mode="solver">
                                <i data-lucide="calculator"></i>
                                <h3>æ™ºèƒ½è§£é¢˜</h3>
                                <p>ä¸Šä¼ é¢˜ç›®å›¾ç‰‡ï¼ŒAI è‡ªåŠ¨è§£ç­”</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ„å›¾ç¡®è®¤å¼¹çª— -->
                <div class="intent-confirm hidden" id="intent-confirm">
                    <div class="intent-header">
                        <i data-lucide="help-circle"></i>
                        <span>æˆ‘ä¸å¤ªç¡®å®šæ‚¨æƒ³åšä»€ä¹ˆï¼Œè¯·é€‰æ‹©ï¼š</span>
                    </div>
                    <div class="intent-options">
                        <button class="intent-option" data-intent="chat">
                            <i data-lucide="message-circle"></i>
                            <span>ğŸ’¬ èŠä¸€èŠ</span>
                        </button>
                        <button class="intent-option" data-intent="manim">
                            <i data-lucide="clapperboard"></i>
                            <span>ğŸ¬ ç”ŸæˆåŠ¨ç”»</span>
                        </button>
                        <button class="intent-option" data-intent="solver">
                            <i data-lucide="calculator"></i>
                            <span>ğŸ“ è§£è¿™é“é¢˜</span>
                        </button>
                    </div>
                </div>

                <!-- åŠ è½½çŠ¶æ€ -->
                <div class="loading hidden" id="loading">
                    <div class="loading-spinner"></div>
                    <span id="loading-text">AI æ­£åœ¨æ€è€ƒä¸­...</span>
                </div>

                <!-- è¾“å…¥åŒºåŸŸ -->
                <div class="input-area">
                    <div class="input-container">
                        <button id="upload-btn" class="icon-btn upload-btn" title="ä¸Šä¼ å›¾ç‰‡" aria-label="ä¸Šä¼ å›¾ç‰‡"><i
                                data-lucide="paperclip"></i></button>

                        <div class="input-wrapper">
                            <input id="chat-input" type="text" placeholder="è¾“å…¥æ¶ˆæ¯ï¼Œæˆ–ä¸Šä¼ å›¾ç‰‡..." autocomplete="off"
                                aria-label="è¾“å…¥æ¡†" />
                            <div id="ghost-input"></div>
                        </div>

                        <button id="send-btn" class="icon-btn send-btn" title="å‘é€" aria-label="å‘é€æ¶ˆæ¯"><i
                                data-lucide="send"></i></button>
                    </div>

                    <div class="toolbar">
                        <button class="icon-btn more-btn" id="more-btn" aria-label="æ›´å¤šé€‰é¡¹"><i
                                data-lucide="settings"></i></button>
                        <div class="dropdown-content" id="dropdownMenu">
                            <div class="dropdown-item" id="btn-tts">
                                <span id="tts-label" style="display: flex; align-items: center; gap: 8px;">
                                    <i data-lucide="volume-x" style="width: 16px;"></i> æœ—è¯»: å…³
                                </span>
                            </div>

                            <div class="dropdown-item" id="btn-clear"
                                style="color:#ff5252; display: flex; align-items: center; gap: 8px;">
                                <i data-lucide="trash-2" style="width: 16px;"></i> æ¸…ç©ºå¯¹è¯
                            </div>
                        </div>
                    </div>
                </div>
            </main>
            <!-- ä¾§è¾¹æ é®ç½© moved to top -->
        </div>
    </div>

    <!-- æ‚¬æµ®é¢˜ç›®çœ‹æ¿ (Context Panel - Ported from MathSolver) -->
    <div id="context-panel" class="context-panel hidden">
        <div class="context-header" id="context-header">
            <div class="context-title">
                <i data-lucide="clipboard-list"></i> <span>é¢˜ç›®çœ‹æ¿</span>
            </div>
            <div class="context-controls">
                <button id="context-lock-btn" class="context-toggle-btn" title="é”å®š/è§£é”çœ‹æ¿å†…å®¹">
                    <i data-lucide="unlock"></i>
                </button>
                <button id="context-toggle-btn" class="context-toggle-btn" title="æ”¶èµ·/å±•å¼€">
                    <i data-lucide="chevron-left"></i>
                </button>
            </div>
        </div>
        <div class="context-body">
            <div class="context-image-container">
                <img id="context-image" src="" alt="é¢˜ç›®å›¾ç‰‡" onclick="openImageLightbox(this.src)">
            </div>
            <div class="context-text-container" id="context-text">
                <!-- é¢˜ç›®æ–‡å­— -->
            </div>
        </div>

        <!-- Resize Handles -->
        <div class="resizer resizer-r"></div>
        <div class="resizer resizer-b"></div>
        <div class="resizer resizer-rb"></div>
        <div class="resizer resizer-l"></div>
        <div class="resizer resizer-lb"></div>
        <div class="resizer resizer-t"></div>
        <div class="resizer resizer-tr"></div>
        <div class="resizer resizer-tl"></div>
    </div>

    <!-- ç§»åŠ¨ç«¯ FAB -->
    <!-- ç§»åŠ¨ç«¯ FAB -->
    <button id="mobile-context-fab" class="mobile-context-fab">
        <i data-lucide="clipboard-list"></i>
    </button>

    <!-- ç§»åŠ¨ç«¯ Modal -->
    <div id="mobile-context-modal" class="mobile-context-modal">
        <div class="mobile-modal-overlay"></div>
        <div class="mobile-modal-content">
            <div class="mobile-modal-header">
                <h3>å½“å‰é¢˜ç›®</h3>
                <div class="mobile-modal-header">
                    <h3>å½“å‰é¢˜ç›®</h3>
                    <button id="mobile-modal-close"><i data-lucide="x"></i></button>
                </div>
            </div>
            <div class="mobile-modal-body">
                <img id="mobile-context-image" src="" alt="é¢˜ç›®" onclick="openImageLightbox(this.src)">
                <div id="mobile-context-text"></div>
            </div>
        </div>
    </div>

    <!-- è£å‰ªæ¨¡æ€æ¡† (Ported from MathSolver) -->
    <div class="crop-modal" id="crop-modal">
        <div class="crop-header">
            <span class="crop-title">è£å‰ªå›¾ç‰‡</span>
            <div class="crop-header">
                <span class="crop-title">è£å‰ªå›¾ç‰‡</span>
                <button class="icon-btn" id="btn-crop-cancel"><i data-lucide="x"></i></button>
            </div>
        </div>
        <div class="crop-container">
            <img id="crop-image" src="">
        </div>
        <div class="crop-footer">
            <button class="btn btn-secondary" id="btn-crop-reset">é‡ç½®</button>
            <button class="btn btn-primary" id="btn-crop-confirm">ç¡®è®¤è£å‰ª</button>
        </div>
    </div>

    <!-- å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† -->
    <div class="image-preview-modal hidden" id="image-preview-modal">
        <div class="preview-content">
            <img id="preview-image" src="" alt="é¢„è§ˆ">
            <div class="preview-actions">
                <button class="btn btn-secondary" id="preview-cancel">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="preview-confirm">å‘é€å›¾ç‰‡</button>
            </div>
        </div>
    </div>

    <!-- Toast å®¹å™¨ -->
    <div id="toast-container" class="toast-container"></div>

    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
    <input type="file" id="file-input" accept="image/*" style="display: none;">

    <!-- Scripts -->
    <script>
        // Icons already initialized in <head>, this is a fallback for dynamic content
        if (window.lucide) { window.lucide.createIcons(); }
    </script>
    <!-- Monaco Editor -->
    <link rel="stylesheet" data-name="vs/editor/editor.main" href="js/libs/monaco/vs/editor/editor.main.css">

    <!-- Code Panel Overlay -->
    <div id="code-panel-overlay" class="code-panel-overlay"></div>

    <!-- Code Editor Panel (Manim Pro Max) -->
    <div id="code-panel" class="code-panel">
        <div class="panel-header">
            <div class="panel-title">
                ğŸ“ Manim Studio
            </div>
            <div class="panel-controls">
                <!-- Desktop Controls -->
                <button id="code-render-btn" class="panel-btn panel-btn-primary">
                    <i data-lucide="play" style="width:16px;"></i> è¿è¡Œ
                </button>
                <button id="code-close-btn" class="panel-btn panel-btn-close">
                    <i data-lucide="x" style="width:20px;"></i>
                </button>
            </div>
        </div>

        <!-- Mobile Tab Bar (Hidden on Desktop) -->
        <div class="mobile-panel-tabs">
            <button class="mobile-panel-tab active" data-tab="preview">
                <i data-lucide="video"></i> <span>é¢„è§ˆ</span>
            </button>
            <button class="mobile-panel-tab" data-tab="code">
                <i data-lucide="code-2"></i> <span>ä»£ç </span>
            </button>
        </div>

        <div class="panel-body">
            <!-- Mobile Preview Tab (Video + History + AI Input) -->
            <div class="mobile-preview-tab" id="mobile-preview-tab">
                <div id="video-preview-container" class="panel-preview">
                    <!-- Video Wrapper (Target for renderCode) -->
                    <div id="video-inner-container">
                        <!-- Video inserted by JS -->
                        <div class="video-preview-placeholder"
                            style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:var(--manim-text-muted);">
                            <i data-lucide="clapperboard"
                                style="width:48px; height:48px; opacity:0.5; margin-bottom:12px;"></i>
                            <p>è§†é¢‘é¢„è§ˆåŒº</p>
                        </div>
                    </div>
                </div>
                <!-- History (Inside Preview Tab on Mobile) - Takes 50% of screen -->
                <div id="manim-history-root" class="history-list-container"></div>
                <!-- AI Footer (Inside Preview Tab on Mobile) -->
                <div class="panel-footer mobile-preview-footer">
                    <div class="ai-input-wrapper">
                        <input type="text" id="ai-instruction-input" class="ai-instruction-input"
                            placeholder="âœ¨ AI åŠ©æ‰‹: æŠŠåœ†æ”¹æˆçº¢è‰²ï¼Œæˆ–è€…è®©å®ƒæ—‹è½¬..." autocomplete="off">
                    </div>
                    <button id="ai-modify-btn" class="panel-btn panel-btn-primary">
                        <i data-lucide="sparkles" style="width:16px;"></i> ç”Ÿæˆ
                    </button>
                </div>
            </div>

            <!-- Mobile Code Tab (Editor Only) -->
            <div class="mobile-code-tab" id="mobile-code-tab">
                <div class="panel-editor">
                    <div class="editor-toolbar">
                        <div class="editor-tab">MainScene.py</div>
                    </div>
                    <div id="monaco-container"></div>
                </div>
            </div>
        </div>

        <!-- Desktop Footer (Only shown on desktop) -->
        <div class="panel-footer desktop-footer">
            <div class="ai-input-wrapper">
                <input type="text" id="ai-instruction-input-desktop" class="ai-instruction-input"
                    placeholder="âœ¨ AI åŠ©æ‰‹: æŠŠåœ†æ”¹æˆçº¢è‰²ï¼Œæˆ–è€…è®©å®ƒæ—‹è½¬..." autocomplete="off">
            </div>
            <button id="ai-modify-btn-desktop" class="panel-btn panel-btn-primary">
                <i data-lucide="sparkles" style="width:16px;"></i> ç”Ÿæˆ
            </button>
        </div>

        <!-- Mobile/Legacy References (Hidden) -->
        <div class="mobile-tabs" style="display:none;">
            <button class="mobile-tab-btn" data-tab="video"></button>
            <button class="mobile-tab-btn" data-tab="code"></button>
        </div>
        <div class="mobile-code-view" style="display:none;"></div>
    </div>

    <!-- Monaco Editor Loader handled in head script -->
    <!-- Removed static script tags to prevent race conditions -->

    <!-- Cropper.js for image cropping -->
    <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.1/dist/cropper.min.css">

    <!-- Core Modules (Dependency Order - same as MathSolver) -->
    <script src="js/constants.js"></script>
    <script src="js/state_manager.js"></script>
    <script src="js/math_renderer.js"></script>
    <script src="js/api_client.js"></script>
    <script src="js/content_detector.js"></script>
    <script src="js/smart_renderer.js"></script>
    <script src="js/ui_manager.js"></script>
    <script src="js/theme_manager.js"></script>
    <script src="js/cursor_effects.js"></script>
    <script src="js/tts_handler.js"></script>
    <script src="js/chat_system.js"></script>
    <script src="js/cropper_handler.js"></script>
    <script src="js/context_panel.js"></script>
    <script type="module" src="js/particle_engine.js"></script>
    <!-- Tools Module -->
    <script type="module" src="js/tools/app-launcher.js"></script>
    <!-- Main App -->
    <script type="module" src="js/app.js"></script>
</body>

</html>